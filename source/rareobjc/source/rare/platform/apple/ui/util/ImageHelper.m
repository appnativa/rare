//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: /Code/Dev/appNativa/source/rareobjc/../rare/apple/com/appnativa/rare/platform/apple/ui/util/ImageHelper.java
//
//  Created by decoteaud on 12/8/15.
//

#include "IOSClass.h"
#include "com/appnativa/rare/Platform.h"
#include "com/appnativa/rare/iPlatformAppContext.h"
#include "com/appnativa/rare/net/ActionLink.h"
#include "com/appnativa/rare/net/JavaURLConnection.h"
#include "com/appnativa/rare/net/NSURLConnectionHelper.h"
#include "com/appnativa/rare/net/iURLConnection.h"
#include "com/appnativa/rare/platform/apple/ui/util/ImageHelper.h"
#include "com/appnativa/rare/platform/apple/ui/util/ImageUtils.h"
#include "com/appnativa/rare/ui/ScreenUtils.h"
#include "com/appnativa/rare/ui/UIColor.h"
#include "com/appnativa/rare/ui/UIImage.h"
#include "com/appnativa/rare/ui/UIImageIcon.h"
#include "com/appnativa/rare/ui/UIProperties.h"
#include "com/appnativa/rare/ui/iPlatformIcon.h"
#include "com/appnativa/rare/ui/painter/iImagePainter.h"
#include "com/appnativa/rare/widget/iWidget.h"
#include "java/io/IOException.h"
#include "java/lang/Exception.h"
#include "java/lang/Integer.h"
#include "java/lang/InterruptedException.h"
#include "java/lang/Math.h"
#include "java/net/URL.h"

@implementation RAREImageHelper

+ (RAREUIImage *)constrainWithRAREUIImage:(RAREUIImage *)img
                                  withInt:(int)width
                                  withInt:(int)height
                                  withInt:(int)constraints
                          withRAREUIColor:(RAREUIColor *)bg
    withRAREiImagePainter_ScalingTypeEnum:(RAREiImagePainter_ScalingTypeEnum *)scalingType {
  if (scalingType == nil) {
    scalingType = [RAREiImagePainter_ScalingTypeEnum BILINEAR];
  }
  int iw;
  int ih;
  switch (constraints) {
    case 1:
    if ([((RAREUIImage *) nil_chk(img)) getWidth] > width) {
      height = (int) [JavaLangMath maxWithFloat:1 withFloat:height * ((float) width) / ([img getWidth])];
      img = [RAREImageUtils getScaledImageWithRAREUIImage:img withInt:width withInt:height withRAREiImagePainter_ScalingTypeEnum:scalingType];
    }
    break;
    case 2:
    if ([((RAREUIImage *) nil_chk(img)) getHeight] > height) {
      width = (int) [JavaLangMath maxWithFloat:1 withFloat:width * ((float) (height) / (float) [img getHeight])];
      img = [RAREImageUtils getScaledImageWithRAREUIImage:img withInt:width withInt:height withRAREiImagePainter_ScalingTypeEnum:scalingType];
    }
    break;
    case 3:
    iw = [((RAREUIImage *) nil_chk(img)) getWidth];
    ih = [img getHeight];
    if ((iw > 0) && (ih > 0)) {
      if ((iw > width) || (ih > height)) {
        if (iw > width) {
          ih = (int) (((float) width / (float) iw) * ih);
          iw = width;
        }
        if (ih > height) {
          iw = (int) (((float) height / (float) ih) * iw);
          ih = height;
        }
        if ((iw > 0) && (ih > 0)) {
          img = [RAREImageUtils getScaledImageWithRAREUIImage:img withInt:iw withInt:ih withRAREiImagePainter_ScalingTypeEnum:scalingType];
          if (bg != nil) {
          }
        }
      }
    }
    break;
    case 4:
    iw = [((RAREUIImage *) nil_chk(img)) getWidth];
    ih = [img getHeight];
    if ((iw > 0) && (ih > 0) && ((iw != width) || (ih != height))) {
      img = [RAREImageUtils getScaledImageWithRAREUIImage:img withInt:width withInt:height withRAREiImagePainter_ScalingTypeEnum:scalingType];
    }
    break;
    case 5:
    iw = [((RAREUIImage *) nil_chk(img)) getWidth];
    ih = [img getHeight];
    if ((iw > 0) && (ih > 0) && ((iw != width) || (ih != height))) {
      if (iw > ih) {
        ih = (int) (((float) width / (float) iw) * ih);
        iw = width;
      }
      else if (ih > iw) {
        iw = (int) (((float) height / (float) ih) * iw);
        ih = height;
      }
      else {
        iw = width;
        ih = height;
      }
      img = [RAREImageUtils getScaledImageWithRAREUIImage:img withInt:iw withInt:ih withRAREiImagePainter_ScalingTypeEnum:scalingType];
      if (bg != nil) {
      }
    }
    break;
    default:
    break;
  }
  return img;
}

+ (RAREUIImageIcon *)createDisabledIconWithRAREiPlatformIcon:(id<RAREiPlatformIcon>)icon {
  if (icon == nil) {
    return nil;
  }
  if ([(id) icon isKindOfClass:[RAREUIImageIcon class]]) {
    return [[RAREUIImageIcon alloc] initWithRAREUIImage:[RAREImageHelper createDisabledImageWithRAREUIImage:[((RAREUIImageIcon *) check_class_cast(icon, [RAREUIImageIcon class])) getImage]]];
  }
  RAREUIImage *image;
  image = [RAREImageUtils createImageWithRAREiPlatformIcon:icon];
  return [[RAREUIImageIcon alloc] initWithRAREUIImage:[RAREImageHelper createDisabledImageWithRAREUIImage:image]];
}

+ (RAREUIImage *)createDisabledImageWithRAREUIImage:(RAREUIImage *)image {
  return [[RAREUIImage alloc] initWithId:[RAREImageUtils createDisabledImageWithId:[((RAREUIImage *) nil_chk(image)) getProxy]]];
}

+ (RAREUIImageIcon *)createIconWithJavaNetURL:(JavaNetURL *)url
                                  withBoolean:(BOOL)defer
                                    withFloat:(float)density {
  return (url == nil) ? nil : [RAREImageHelper createIconWithJavaNetURL:url withNSString:[url toExternalForm] withNSString:nil withBoolean:defer withFloat:density];
}

+ (RAREUIImageIcon *)createIconWithJavaNetURL:(JavaNetURL *)url
                                 withNSString:(NSString *)description_
                                 withNSString:(NSString *)name
                                  withBoolean:(BOOL)defer
                                    withFloat:(float)density {
  if (url == nil) {
    return nil;
  }
  @try {
    if (description_ == nil) {
      description_ = [((JavaNetURL *) nil_chk(url)) toExternalForm];
    }
    return [[RAREUIImageIcon alloc] initWithRAREUIImage:[RAREImageHelper createImageWithJavaNetURL:url withBoolean:defer withFloat:density] withNSString:description_ withNSString:name];
  }
  @catch (JavaIoIOException *ex) {
    [RAREPlatform ignoreExceptionWithNSString:[((JavaNetURL *) nil_chk(url)) toExternalForm] withJavaLangThrowable:ex];
    url = nil;
    return [[RAREUIImageIcon alloc] initWithRAREUIImage:[RAREaUIImageIcon getBrokenImage]];
  }
}

+ (RAREUIImage *)createImageWithRAREiWidget:(id<RAREiWidget>)context
                         withRAREActionLink:(RAREActionLink *)link
                                withBoolean:(BOOL)defer
                                  withFloat:(float)density {
  return [RAREImageHelper createImageWithJavaNetURL:[((RAREActionLink *) nil_chk(link)) getURLWithRAREiWidget:context] withBoolean:defer withFloat:density];
}

+ (RAREUIImage *)createImageWithJavaNetURL:(JavaNetURL *)url
                               withBoolean:(BOOL)defer
                                 withFloat:(float)density {
  return [RAREImageHelper createImageWithJavaNetURL:url withBoolean:defer withInt:0 withInt:0 withRAREiImagePainter_ScalingTypeEnum:nil withRAREUIColor:nil withFloat:density];
}

+ (RAREUIImage *)createImageWithJavaNetURL:(JavaNetURL *)url
                               withBoolean:(BOOL)defer
                                   withInt:(int)size
                                   withInt:(int)constraints
     withRAREiImagePainter_ScalingTypeEnum:(RAREiImagePainter_ScalingTypeEnum *)st
                           withRAREUIColor:(RAREUIColor *)bg
                                 withFloat:(float)density {
  if (url == nil) {
    return nil;
  }
  if ([((NSString *) nil_chk([((JavaNetURL *) nil_chk(url)) getProtocol])) isEqual:@"file"]) {
    defer = NO;
  }
  if (density == 0) {
    density = [RAREScreenUtils getDefaultIconDensity];
  }
  id<RAREiPlatformAppContext> app = [RAREPlatform getAppContext];
  if (defer && [RAREPlatform isUIThread]) {
    return [[RAREImageHelper_DelayedImage alloc] initWithRAREiPlatformAppContext:app withJavaNetURL:url withInt:size withInt:constraints withRAREiImagePainter_ScalingTypeEnum:st withRAREUIColor:bg withFloat:density];
  }
  id<RAREiURLConnection> conn = [((id<RAREiPlatformAppContext>) nil_chk(app)) openConnectionWithJavaNetURL:url];
  @try {
    JavaLangInteger *to = (JavaLangInteger *) check_class_cast([((RAREUIProperties *) nil_chk([app getUIDefaults])) getWithNSString:@"Rare.net.imageLoadTimeout"], [JavaLangInteger class]);
    int tm = (to == nil) ? 100 * 60 * 10 : [to intValue];
    id proxy = [RAREImageUtils createImageProxyWithJavaNetURL:url withInt:tm withFloat:density];
    RAREUIImage *img = [[RAREUIImage alloc] initWithId:proxy withNSString:[RAREJavaURLConnection toExternalFormWithJavaNetURL:url]];
    if ((constraints > 0) && (size > 0)) {
      img = [RAREImageHelper constrainWithRAREUIImage:img withInt:size withInt:size withInt:constraints withRAREUIColor:bg withRAREiImagePainter_ScalingTypeEnum:st];
    }
    return img;
  }
  @finally {
    [((id<RAREiURLConnection>) nil_chk(conn)) dispose];
    conn = nil;
  }
}

+ (RAREUIImage *)createImageWithJavaNetURL:(JavaNetURL *)url
                                    withId:(id)proxy
                               withBoolean:(BOOL)densityScale
                                   withInt:(int)size
                                   withInt:(int)constraints
     withRAREiImagePainter_ScalingTypeEnum:(RAREiImagePainter_ScalingTypeEnum *)st
                           withRAREUIColor:(RAREUIColor *)bg
                                 withFloat:(float)density {
  if (url == nil) {
    return nil;
  }
  RAREUIImage *img = [[RAREUIImage alloc] initWithId:proxy withNSString:[RAREJavaURLConnection toExternalFormWithJavaNetURL:url]];
  if ((constraints > 0) && (size > 0)) {
    img = [RAREImageHelper constrainWithRAREUIImage:img withInt:size withInt:size withInt:constraints withRAREUIColor:bg withRAREiImagePainter_ScalingTypeEnum:st];
  }
  return img;
}

+ (RAREUIImage *)ensureImageLoadedWithRAREUIImage:(RAREUIImage *)img {
  if ([img isKindOfClass:[RAREImageHelper_DelayedImage class]]) {
    return [((RAREImageHelper_DelayedImage *) check_class_cast(img, [RAREImageHelper_DelayedImage class])) getRealImage];
  }
  return img;
}

+ (RAREUIImage *)scaleImageWithRAREUIImage:(RAREUIImage *)image
                                   withInt:(int)width
                                   withInt:(int)height {
  if ([image isKindOfClass:[RAREImageHelper_DelayedImage class]]) {
    image = [((RAREImageHelper_DelayedImage *) check_class_cast(image, [RAREImageHelper_DelayedImage class])) getRealImage];
  }
  if ((image == nil) || (([image getWidth] == width) && ([image getHeight] == height))) {
    return image;
  }
  return [RAREImageUtils getScaledImageWithRAREUIImage:image withInt:width withInt:height withRAREiImagePainter_ScalingTypeEnum:[RAREiImagePainter_ScalingTypeEnum BILINEAR]];
}

- (id)init {
  return [super init];
}

+ (J2ObjcClassInfo *)__metadata {
  static J2ObjcMethodInfo methods[] = {
    { "constrainWithRAREUIImage:withInt:withInt:withInt:withRAREUIColor:withRAREiImagePainter_ScalingTypeEnum:", NULL, "LRAREUIImage", 0x9, NULL },
    { "createDisabledIconWithRAREiPlatformIcon:", NULL, "LRAREUIImageIcon", 0x9, NULL },
    { "createDisabledImageWithRAREUIImage:", NULL, "LRAREUIImage", 0x9, NULL },
    { "createIconWithJavaNetURL:withBoolean:withFloat:", NULL, "LRAREUIImageIcon", 0x9, NULL },
    { "createIconWithJavaNetURL:withNSString:withNSString:withBoolean:withFloat:", NULL, "LRAREUIImageIcon", 0x9, NULL },
    { "createImageWithRAREiWidget:withRAREActionLink:withBoolean:withFloat:", NULL, "LRAREUIImage", 0x9, "JavaIoIOException" },
    { "createImageWithJavaNetURL:withBoolean:withFloat:", NULL, "LRAREUIImage", 0x9, "JavaIoIOException" },
    { "createImageWithJavaNetURL:withBoolean:withInt:withInt:withRAREiImagePainter_ScalingTypeEnum:withRAREUIColor:withFloat:", NULL, "LRAREUIImage", 0x9, "JavaIoIOException" },
    { "createImageWithJavaNetURL:withId:withBoolean:withInt:withInt:withRAREiImagePainter_ScalingTypeEnum:withRAREUIColor:withFloat:", NULL, "LRAREUIImage", 0x9, "JavaIoIOException" },
    { "ensureImageLoadedWithRAREUIImage:", NULL, "LRAREUIImage", 0x9, NULL },
    { "scaleImageWithRAREUIImage:withInt:withInt:", NULL, "LRAREUIImage", 0x9, NULL },
  };
  static J2ObjcClassInfo _RAREImageHelper = { "ImageHelper", "com.appnativa.rare.platform.apple.ui.util", NULL, 0x1, 11, methods, 0, NULL, 0, NULL};
  return &_RAREImageHelper;
}

@end
@implementation RAREImageHelper_DelayedImage

- (id)initWithRAREiPlatformAppContext:(id<RAREiPlatformAppContext>)app
                       withJavaNetURL:(JavaNetURL *)url {
  return [self initRAREImageHelper_DelayedImageWithRAREiPlatformAppContext:app withJavaNetURL:url withInt:0 withInt:0 withRAREiImagePainter_ScalingTypeEnum:nil withRAREUIColor:nil withFloat:[RAREScreenUtils getDefaultIconDensity]];
}

- (id)initRAREImageHelper_DelayedImageWithRAREiPlatformAppContext:(id<RAREiPlatformAppContext>)app
                                                   withJavaNetURL:(JavaNetURL *)url
                                                          withInt:(int)size
                                                          withInt:(int)constraints
                            withRAREiImagePainter_ScalingTypeEnum:(RAREiImagePainter_ScalingTypeEnum *)scalingType
                                                  withRAREUIColor:(RAREUIColor *)background
                                                        withFloat:(float)density {
  if (self = [super init]) {
    height_ = -1;
    width_ = -1;
    if (app == nil) {
      app = [RAREPlatform getAppContext];
    }
    if (![((id<RAREiPlatformAppContext>) nil_chk(app)) isShuttingDown]) {
      self->url_ = url;
      self->background_ = background;
      self->size_ = size;
      self->scalingType_ = scalingType;
      self->constraints_ = constraints;
      self->density_ = density;
      future_ = [[RARENSURLConnectionHelper alloc] init];
      [future_ sendURLWithJavaNetURL:url withRAREiFunctionCallback:self];
    }
  }
  return self;
}

- (id)initWithRAREiPlatformAppContext:(id<RAREiPlatformAppContext>)app
                       withJavaNetURL:(JavaNetURL *)url
                              withInt:(int)size
                              withInt:(int)constraints
withRAREiImagePainter_ScalingTypeEnum:(RAREiImagePainter_ScalingTypeEnum *)scalingType
                      withRAREUIColor:(RAREUIColor *)background
                            withFloat:(float)density {
  return [self initRAREImageHelper_DelayedImageWithRAREiPlatformAppContext:app withJavaNetURL:url withInt:size withInt:constraints withRAREiImagePainter_ScalingTypeEnum:scalingType withRAREUIColor:background withFloat:density];
}

- (RAREUIImage *)call {
  RAREUIImage *img = nil;
  if (![RAREPlatform isShuttingDown]) {
    @try {
      if (url_ != nil) {
        img = [RAREImageHelper createImageWithJavaNetURL:url_ withBoolean:NO withFloat:density_];
      }
      if ((img != nil) && (constraints_ > 0) && (size_ > 0)) {
        img = [RAREImageHelper constrainWithRAREUIImage:img withInt:size_ withInt:size_ withInt:constraints_ withRAREUIColor:background_ withRAREiImagePainter_ScalingTypeEnum:scalingType_];
      }
      image_ = img;
    }
    @catch (JavaLangException *ex) {
      img = image_ = [RAREaUIImageIcon getBrokenImage];
      [RAREPlatform ignoreExceptionWithNSString:(url_ == nil) ? nil : [url_ toExternalForm] withJavaLangThrowable:ex];
    }
  }
  future_ = nil;
  url_ = nil;
  if (img != nil) {
    proxy_ = [img getProxy];
  }
  [RAREPlatform invokeLaterWithJavaLangRunnable:[[RAREImageHelper_DelayedImage_$1 alloc] initWithRAREImageHelper_DelayedImage:self]];
  return img;
}

- (void)cancelWithBoolean:(BOOL)canInterrupt {
  RARENSURLConnectionHelper *h = future_;
  future_ = nil;
  if (h != nil) {
    canceled_ = YES;
    self->url_ = nil;
    @try {
      [h cancel];
    }
    @catch (JavaLangException *ignore) {
    }
  }
}

- (void)finishedWithBoolean:(BOOL)canceled
                     withId:(id)returnValue {
  RARENSURLConnectionHelper *h = (RARENSURLConnectionHelper *) check_class_cast(returnValue, [RARENSURLConnectionHelper class]);
  NSString *s = (url_ == nil) ? @"" : [url_ toExternalForm];
  if (canceled) {
    NSString *err = [((RARENSURLConnectionHelper *) nil_chk(h)) getError];
    if (!self->canceled_ && (err != nil)) {
      s = [NSString stringWithFormat:@"%@%@", s, [NSString stringWithFormat:@"\n%@", err]];
      [RAREPlatform debugLogWithNSString:s];
    }
    image_ = [RAREaUIImageIcon getBrokenImage];
    proxy_ = [((RAREUIImage *) nil_chk(image_)) getProxy];
  }
  else {
    proxy_ = [RAREImageUtils createImageProxyWithId:[((RARENSURLConnectionHelper *) nil_chk(h)) getData] withFloat:density_];
    self->image_ = [[RAREUIImage alloc] initWithId:proxy_ withNSString:s];
  }
  [((RARENSURLConnectionHelper *) nil_chk(h)) dispose];
  future_ = nil;
  [RAREPlatform invokeLaterWithJavaLangRunnable:[[RAREImageHelper_DelayedImage_$2 alloc] initWithRAREImageHelper_DelayedImage:self]];
}

- (void)flush {
}

- (void)setHeightWithInt:(int)height {
  self->height_ = height;
}

- (void)setWidthWithInt:(int)width {
  self->width_ = width;
}

- (int)getHeight {
  return (image_ == nil) ? height_ : [image_ getHeight];
}

- (RAREUIImage *)getRealImage {
  id f = future_;
  RAREUIImage *img = self->image_;
  if ((img == nil) && (f != nil)) {
    @synchronized (self) {
      hasWaiters_ = YES;
      @try {
        [self wait];
      }
      @catch (JavaLangInterruptedException *ignore) {
        if (self->image_ == nil) {
          self->image_ = [RAREaUIImageIcon getBrokenImage];
        }
      }
    }
  }
  return self->image_;
}

- (RAREUIImage *)getSubimageWithInt:(int)x
                            withInt:(int)y
                            withInt:(int)w
                            withInt:(int)h {
  return [((RAREUIImage *) nil_chk([self getRealImage])) getSubimageWithInt:x withInt:y withInt:w withInt:h];
}

- (int)getWidth {
  return (image_ == nil) ? width_ : [image_ getWidth];
}

- (BOOL)isCanceled {
  return canceled_;
}

- (BOOL)isDone {
  return (future_ == nil);
}

- (BOOL)isLoadedExWithBoolean:(BOOL)hasObserver {
  return image_ != nil;
}

- (void)copyAllFieldsTo:(RAREImageHelper_DelayedImage *)other {
  [super copyAllFieldsTo:other];
  other->constraints_ = constraints_;
  other->density_ = density_;
  other->future_ = future_;
  other->hasWaiters_ = hasWaiters_;
  other->height_ = height_;
  other->image_ = image_;
  other->size_ = size_;
  other->url_ = url_;
  other->width_ = width_;
}

+ (J2ObjcClassInfo *)__metadata {
  static J2ObjcMethodInfo methods[] = {
    { "initWithRAREiPlatformAppContext:withJavaNetURL:withInt:withInt:withRAREiImagePainter_ScalingTypeEnum:withRAREUIColor:withFloat:", NULL, NULL, 0x2, NULL },
    { "call", NULL, "LRAREUIImage", 0x1, "JavaLangException" },
    { "getRealImage", NULL, "LRAREUIImage", 0x1, NULL },
    { "getSubimageWithInt:withInt:withInt:withInt:", NULL, "LRAREUIImage", 0x1, NULL },
    { "isCanceled", NULL, "Z", 0x1, NULL },
    { "isDone", NULL, "Z", 0x1, NULL },
    { "isLoadedExWithBoolean:", NULL, "Z", 0x4, NULL },
  };
  static J2ObjcFieldInfo fields[] = {
    { "image_", NULL, 0x42, "LRAREUIImage" },
    { "url_", NULL, 0x42, "LJavaNetURL" },
    { "hasWaiters_", NULL, 0x0, "Z" },
  };
  static J2ObjcClassInfo _RAREImageHelper_DelayedImage = { "DelayedImage", "com.appnativa.rare.platform.apple.ui.util", "ImageHelper", 0x9, 7, methods, 3, fields, 0, NULL};
  return &_RAREImageHelper_DelayedImage;
}

@end
@implementation RAREImageHelper_DelayedImage_$1

- (void)run {
  [this$0_ notifyObserversWithRAREUIImage:this$0_];
}

- (id)initWithRAREImageHelper_DelayedImage:(RAREImageHelper_DelayedImage *)outer$ {
  this$0_ = outer$;
  return [super init];
}

+ (J2ObjcClassInfo *)__metadata {
  static J2ObjcFieldInfo fields[] = {
    { "this$0_", NULL, 0x1012, "LRAREImageHelper_DelayedImage" },
  };
  static J2ObjcClassInfo _RAREImageHelper_DelayedImage_$1 = { "$1", "com.appnativa.rare.platform.apple.ui.util", "ImageHelper$DelayedImage", 0x8000, 0, NULL, 1, fields, 0, NULL};
  return &_RAREImageHelper_DelayedImage_$1;
}

@end
@implementation RAREImageHelper_DelayedImage_$2

- (void)run {
  [this$0_ notifyObserversWithRAREUIImage:this$0_];
}

- (id)initWithRAREImageHelper_DelayedImage:(RAREImageHelper_DelayedImage *)outer$ {
  this$0_ = outer$;
  return [super init];
}

+ (J2ObjcClassInfo *)__metadata {
  static J2ObjcFieldInfo fields[] = {
    { "this$0_", NULL, 0x1012, "LRAREImageHelper_DelayedImage" },
  };
  static J2ObjcClassInfo _RAREImageHelper_DelayedImage_$2 = { "$2", "com.appnativa.rare.platform.apple.ui.util", "ImageHelper$DelayedImage", 0x8000, 0, NULL, 1, fields, 0, NULL};
  return &_RAREImageHelper_DelayedImage_$2;
}

@end
