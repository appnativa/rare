//
//  Generated by the J2ObjC translator.  DO NOT EDIT!
//  source: /Code/Dev/appNativa/source/rareobjc/../rare/apple/com/appnativa/rare/ui/UIImageIcon.java
//
//  Created by decoteaud on 3/11/16.
//

#include "com/appnativa/rare/Platform.h"
#include "com/appnativa/rare/platform/PlatformHelper.h"
#include "com/appnativa/rare/platform/apple/ui/util/ImageHelper.h"
#include "com/appnativa/rare/ui/UIColor.h"
#include "com/appnativa/rare/ui/UIImage.h"
#include "com/appnativa/rare/ui/UIImageIcon.h"
#include "com/appnativa/rare/ui/aUIImageIcon.h"
#include "com/appnativa/rare/ui/iImageObserver.h"
#include "com/appnativa/rare/ui/iPlatformPaint.h"
#include "java/lang/Exception.h"
#include "java/lang/Runnable.h"
#include "java/net/URL.h"

@implementation RAREUIImageIcon

- (id)init {
  if (self = [super init]) {
    spawned_ = NO;
  }
  return self;
}

- (id)initWithRAREUIImage:(RAREUIImage *)image {
  if (self = [super initWithRAREUIImage:image]) {
    spawned_ = NO;
  }
  return self;
}

- (id)initWithRAREUIImage:(RAREUIImage *)image
             withNSString:(NSString *)description_ {
  if (self = [super initWithRAREUIImage:image withNSString:description_]) {
    spawned_ = NO;
  }
  return self;
}

- (id)initWithRAREUIImage:(RAREUIImage *)image
             withNSString:(NSString *)description_
             withNSString:(NSString *)resource {
  if (self = [super initWithRAREUIImage:image withNSString:description_ withNSString:resource]) {
    spawned_ = NO;
  }
  return self;
}

- (id)initWithJavaNetURL:(JavaNetURL *)location
            withNSString:(NSString *)description_
    withRAREaUIImageIcon:(RAREaUIImageIcon *)delayedIcon
                 withInt:(int)constraints {
  if (self = [super initWithJavaNetURL:location withNSString:description_ withRAREaUIImageIcon:delayedIcon withInt:constraints]) {
    spawned_ = NO;
  }
  return self;
}

- (id)initWithJavaNetURL:(JavaNetURL *)location
            withNSString:(NSString *)description_
    withRAREaUIImageIcon:(RAREaUIImageIcon *)delayedIcon
         withRAREUIColor:(RAREUIColor *)bg {
  if (self = [super initWithJavaNetURL:location withNSString:description_ withRAREaUIImageIcon:delayedIcon withRAREUIColor:bg]) {
    spawned_ = NO;
  }
  return self;
}

- (BOOL)canUseLayer {
  return NO;
}

- (BOOL)canUseMainLayer {
  return NO;
}

- (void)cancelWithBoolean:(BOOL)canInterrupt {
  if (self->location_ != nil) {
    canceled_ = YES;
    self->location_ = nil;
    if (canInterrupt) {
    }
  }
  else if (!loaded_) {
    if ([self->image_ isKindOfClass:[RAREImageHelper_DelayedImage class]]) {
      [((RAREImageHelper_DelayedImage *) check_class_cast(self->image_, [RAREImageHelper_DelayedImage class])) cancelWithBoolean:YES];
    }
  }
}

- (void)dispose {
  [super dispose];
  transientImageObserver_ = nil;
}

- (BOOL)loadingInitiated {
  if (spawned_) {
    return YES;
  }
  if ([self->image_ isKindOfClass:[RAREImageHelper_DelayedImage class]]) {
    return YES;
  }
  return location_ == nil;
}

- (void)run {
  spawned_ = YES;
  JavaNetURL *url = location_;
  @try {
    if (url != nil) {
      @synchronized (url) {
        canceled_ = NO;
        if (self->location_ == nil) {
          return;
        }
        int width = (delayedIcon_ == nil) ? 0 : [delayedIcon_ getIconWidth];
        int height = (delayedIcon_ == nil) ? 0 : [delayedIcon_ getIconHeight];
        @try {
          RAREUIImage *img = [RAREaPlatformHelper createImageWithJavaNetURL:url withBoolean:NO withFloat:0];
          if (img != nil) {
            if ((width > 0) && (height > 0) && (delayedIconConstraints_ > 0)) {
              img = [RAREImageHelper constrainWithRAREUIImage:img withInt:width withInt:height withInt:delayedIconConstraints_ withRAREUIColor:constrainedBackground_ withRAREiImagePainter_ScalingTypeEnum:scalingType_];
            }
            [self setImageWithRAREUIImage:img];
          }
          delayedIcon_ = nil;
        }
        @catch (JavaLangException *e) {
          [RAREPlatform ignoreExceptionWithNSString:@"failed to load image" withJavaLangThrowable:e];
        }
        @finally {
          location_ = nil;
          loaded_ = YES;
          if ([self getImageObserver] != nil) {
            [((id<RAREiImageObserver>) nil_chk([self getImageObserver])) imageLoadedWithRAREUIImage:[self getImage]];
          }
        }
      }
    }
  }
  @finally {
    id<JavaLangRunnable> r = notifieRunner_;
    if (transientImageObserver_ != nil) {
      @try {
        [transientImageObserver_ imageLoadedWithRAREUIImage:[self getImage]];
      }
      @catch (JavaLangException *e) {
      }
    }
    notifieRunner_ = nil;
    transientImageObserver_ = nil;
    if (r != nil) {
      if (runNotifierOnEventThread_) {
        if ([RAREPlatform isUIThread]) {
          [r run];
        }
        else {
          [RAREPlatform invokeLaterWithJavaLangRunnable:r];
        }
      }
      else {
        [r run];
      }
    }
  }
}

- (RAREaUIImageIcon *)getCopyWithNSString:(NSString *)description_ {
  if (description_ == nil) {
    description_ = [self getDescription];
  }
  RAREUIImageIcon *ic = [[RAREUIImageIcon alloc] initWithRAREUIImage:image_ withNSString:description_ withNSString:resourceName_];
  ic->location_ = self->location_;
  ic->linkedData_ = self->linkedData_;
  return ic;
}

- (int)getModCount {
  return 0;
}

- (id<RAREiPlatformPaint>)getPaintWithFloat:(float)width
                                  withFloat:(float)height {
  return nil;
}

- (BOOL)isImageLoadedWithRAREiImageObserver:(id<RAREiImageObserver>)is {
  if (location_ != nil) {
    if (is != nil) {
      transientImageObserver_ = is;
    }
    return NO;
  }
  if ([image_ isKindOfClass:[RAREImageHelper_DelayedImage class]]) {
    BOOL loaded = [((RAREImageHelper_DelayedImage *) check_class_cast(image_, [RAREImageHelper_DelayedImage class])) isImageLoadedWithRAREiImageObserver:is];
    if (loaded) {
      [self imageWasLoaded];
    }
    return loaded;
  }
  else if (location_ != nil) {
    if (is != nil) {
      transientImageObserver_ = is;
    }
    return NO;
  }
  return YES;
}

- (void)imageWasLoaded {
  if (!loaded_) {
    if ([image_ isKindOfClass:[RAREImageHelper_DelayedImage class]]) {
      image_ = [((RAREImageHelper_DelayedImage *) check_class_cast(image_, [RAREImageHelper_DelayedImage class])) getRealImage];
      if (image_ == nil) {
        image_ = [RAREaUIImageIcon getBrokenImage];
      }
    }
    [super imageWasLoaded];
  }
}

- (BOOL)isDelayedImage {
  return [image_ isKindOfClass:[RAREImageHelper_DelayedImage class]];
}

- (void)updateModCount {
}

- (void)copyAllFieldsTo:(RAREUIImageIcon *)other {
  [super copyAllFieldsTo:other];
  other->spawned_ = spawned_;
  other->transientImageObserver_ = transientImageObserver_;
}

+ (J2ObjcClassInfo *)__metadata {
  static J2ObjcMethodInfo methods[] = {
    { "canUseLayer", NULL, "Z", 0x1, NULL },
    { "canUseMainLayer", NULL, "Z", 0x1, NULL },
    { "loadingInitiated", NULL, "Z", 0x1, NULL },
    { "getCopyWithNSString:", NULL, "LRAREaUIImageIcon", 0x1, NULL },
    { "getPaintWithFloat:withFloat:", NULL, "LRAREiPlatformPaint", 0x1, NULL },
    { "isImageLoadedWithRAREiImageObserver:", NULL, "Z", 0x1, NULL },
    { "imageWasLoaded", NULL, "V", 0x4, NULL },
    { "isDelayedImage", NULL, "Z", 0x4, NULL },
  };
  static J2ObjcFieldInfo fields[] = {
    { "spawned_", NULL, 0x42, "Z" },
  };
  static J2ObjcClassInfo _RAREUIImageIcon = { "UIImageIcon", "com.appnativa.rare.ui", NULL, 0x1, 8, methods, 1, fields, 0, NULL};
  return &_RAREUIImageIcon;
}

@end
